<!doctype html>
<html>
    <head>
        <title>DB Service Test Interface</title>
        <link rel="stylesheet" href="./styles.css" />
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üìã Task Manager - DB Service</h1>
                <p>Test Interface for Task Management System</p>
            </div>

            <!-- Authentication Status -->
            <div style="padding: 20px">
                <div id="auth-status" class="unauthenticated">
                    <h3>Authentication Status:</h3>
                    <div id="auth-info">Not authenticated</div>
                    <div id="auth-actions" style="margin-top: 10px">
                        <button id="check-auth-btn" class="btn btn-info">
                            Check Auth Status
                        </button>
                        <button
                            id="logout-btn"
                            class="btn btn-danger"
                            style="display: none"
                        >
                            Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="tab">
                <button
                    class="tablinks"
                    onclick="openTab(event, 'AuthTab')"
                    id="defaultOpen"
                >
                    Authentication
                </button>
                <button class="tablinks" onclick="openTab(event, 'TasksTab')">
                    Tasks
                </button>
                <button
                    class="tablinks"
                    onclick="openTab(event, 'ProjectsTab')"
                >
                    Projects
                </button>
                <button
                    class="tablinks"
                    onclick="openTab(event, 'CategoriesTab')"
                >
                    Categories
                </button>
                <button class="tablinks" onclick="openTab(event, 'TagsTab')">
                    Tags
                </button>
                <button
                    class="tablinks"
                    onclick="openTab(event, 'NotificationsTab')"
                >
                    Notifications
                </button>
                <button class="tablinks" onclick="openTab(event, 'UserTab')">
                    User
                </button>
                <button class="tablinks" onclick="openTab(event, 'ExportTab')">
                    Export
                </button>
            </div>

            <!-- Authentication Tab -->
            <div id="AuthTab" class="tabcontent">
                <h2>üîê Authentication</h2>
                <p>
                    To use the DB Service, you need to authenticate through the
                    Auth Service first.
                </p>

                <div class="card">
                    <h4>Login via Auth Service</h4>
                    <p>Use the link below to login through the auth service:</p>
                    <a
                        href="http://localhost:3000/test/login"
                        target="_blank"
                        class="btn"
                        >Open Auth Service Login</a
                    >

                    <div style="margin-top: 20px">
                        <h4>Manual Token Entry</h4>
                        <div class="form-group">
                            <label for="manual-token">Access Token:</label>
                            <input
                                type="text"
                                id="manual-token"
                                placeholder="Paste your access token here"
                            />
                        </div>
                        <button
                            onclick="setManualToken()"
                            class="btn btn-success"
                        >
                            Set Token
                        </button>
                    </div>
                </div>

                <div
                    id="auth-result"
                    class="result"
                    style="display: none"
                ></div>
            </div>

            <!-- Tasks Tab -->
            <div id="TasksTab" class="tabcontent">
                <h2>üìã Tasks Management</h2>

                <!-- Task Filters -->
                <div class="filters">
                    <h4>Filters & Search</h4>
                    <div class="filter-row">
                        <div class="form-group">
                            <label for="task-search">Search:</label>
                            <input
                                type="text"
                                id="task-search"
                                placeholder="Search tasks..."
                            />
                        </div>
                        <div class="form-group">
                            <label for="task-status-filter">Status:</label>
                            <select id="task-status-filter">
                                <option value="">All Statuses</option>
                                <option value="TODO">To Do</option>
                                <option value="IN_PROGRESS">In Progress</option>
                                <option value="REVIEW">Review</option>
                                <option value="DONE">Done</option>
                                <option value="CANCELED">Canceled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="task-priority-filter">Priority:</label>
                            <select id="task-priority-filter">
                                <option value="">All Priorities</option>
                                <option value="LOW">Low</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="HIGH">High</option>
                                <option value="URGENT">Urgent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button onclick="loadTasks()" class="btn">
                                Search Tasks
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Task Actions -->
                <div class="actions">
                    <button
                        onclick="showCreateTaskForm()"
                        class="btn btn-success"
                    >
                        + Create Task
                    </button>
                    <button onclick="loadTasks()" class="btn btn-info">
                        Refresh Tasks
                    </button>
                    <button
                        onclick="getTaskStatistics()"
                        class="btn btn-secondary"
                    >
                        View Statistics
                    </button>
                    <button onclick="getTasksDueSoon()" class="btn btn-warning">
                        Due Soon
                    </button>
                    <button onclick="getOverdueTasks()" class="btn btn-danger">
                        Overdue Tasks
                    </button>
                </div>

                <!-- Create Task Form -->
                <div id="create-task-form" class="card" style="display: none">
                    <h4>Create New Task</h4>
                    <div class="grid">
                        <div>
                            <div class="form-group">
                                <label for="new-task-title">Title*:</label>
                                <input
                                    type="text"
                                    id="new-task-title"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label for="new-task-description"
                                    >Description:</label
                                >
                                <textarea id="new-task-description"></textarea>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label for="new-task-priority">Priority:</label>
                                <select id="new-task-priority">
                                    <option value="LOW">Low</option>
                                    <option value="MEDIUM" selected>
                                        Medium
                                    </option>
                                    <option value="HIGH">High</option>
                                    <option value="URGENT">Urgent</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="new-task-due-date">Due Date:</label>
                                <input
                                    type="datetime-local"
                                    id="new-task-due-date"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="actions">
                        <button onclick="createTask()" class="btn btn-success">
                            Create Task
                        </button>
                        <button
                            onclick="hideCreateTaskForm()"
                            class="btn btn-secondary"
                        >
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Tasks List -->
                <div id="tasks-container">
                    <div class="loading">
                        Click "Search Tasks" to load tasks
                    </div>
                </div>

                <div
                    id="task-result"
                    class="result"
                    style="display: none"
                ></div>
            </div>

            <!-- Projects Tab -->
            <div id="ProjectsTab" class="tabcontent">
                <h2>üóÇÔ∏è Projects Management</h2>

                <div class="actions">
                    <button
                        onclick="showCreateProjectForm()"
                        class="btn btn-success"
                    >
                        + Create Project
                    </button>
                    <button onclick="loadProjects()" class="btn btn-info">
                        Load Projects
                    </button>
                </div>

                <!-- Create Project Form -->
                <div
                    id="create-project-form"
                    class="card"
                    style="display: none"
                >
                    <h4>Create New Project</h4>
                    <div class="form-group">
                        <label for="new-project-name">Name*:</label>
                        <input type="text" id="new-project-name" required />
                    </div>
                    <div class="form-group">
                        <label for="new-project-description"
                            >Description:</label
                        >
                        <textarea id="new-project-description"></textarea>
                    </div>
                    <div class="actions">
                        <button
                            onclick="createProject()"
                            class="btn btn-success"
                        >
                            Create Project
                        </button>
                        <button
                            onclick="hideCreateProjectForm()"
                            class="btn btn-secondary"
                        >
                            Cancel
                        </button>
                    </div>
                </div>

                <div id="projects-container">
                    <div class="loading">
                        Click "Load Projects" to view projects
                    </div>
                </div>

                <div
                    id="project-result"
                    class="result"
                    style="display: none"
                ></div>
            </div>

            <!-- Categories Tab -->
            <div id="CategoriesTab" class="tabcontent">
                <h2>üè∑Ô∏è Categories Management</h2>

                <div class="actions">
                    <button
                        onclick="showCreateCategoryForm()"
                        class="btn btn-success"
                    >
                        + Create Category
                    </button>
                    <button onclick="loadCategories()" class="btn btn-info">
                        Load Categories
                    </button>
                    <button
                        onclick="getCategoryStats()"
                        class="btn btn-secondary"
                    >
                        View Statistics
                    </button>
                </div>

                <!-- Create Category Form -->
                <div
                    id="create-category-form"
                    class="card"
                    style="display: none"
                >
                    <h4>Create New Category</h4>
                    <div class="form-group">
                        <label for="new-category-name">Name*:</label>
                        <input type="text" id="new-category-name" required />
                    </div>
                    <div class="form-group">
                        <label for="new-category-color">Color:</label>
                        <input
                            type="color"
                            id="new-category-color"
                            value="#4285F4"
                        />
                    </div>
                    <div class="actions">
                        <button
                            onclick="createCategory()"
                            class="btn btn-success"
                        >
                            Create Category
                        </button>
                        <button
                            onclick="hideCreateCategoryForm()"
                            class="btn btn-secondary"
                        >
                            Cancel
                        </button>
                    </div>
                </div>

                <div id="categories-container">
                    <div class="loading">
                        Click "Load Categories" to view categories
                    </div>
                </div>

                <div
                    id="category-result"
                    class="result"
                    style="display: none"
                ></div>
            </div>

            <!-- Tags Tab -->
            <div id="TagsTab" class="tabcontent">
                <h2>üè∑Ô∏è Tags Management</h2>

                <div class="actions">
                    <button
                        onclick="showCreateTagForm()"
                        class="btn btn-success"
                    >
                        + Create Tag
                    </button>
                    <button onclick="loadTags()" class="btn btn-info">
                        Load Tags
                    </button>
                    <button onclick="getTagStats()" class="btn btn-secondary">
                        View Statistics
                    </button>
                    <button onclick="getPopularTags()" class="btn btn-warning">
                        Popular Tags
                    </button>
                </div>

                <!-- Create Tag Form -->
                <div id="create-tag-form" class="card" style="display: none">
                    <h4>Create New Tag</h4>
                    <div class="form-group">
                        <label for="new-tag-name">Name*:</label>
                        <input type="text" id="new-tag-name" required />
                    </div>
                    <div class="form-group">
                        <label for="new-tag-color">Color:</label>
                        <input
                            type="color"
                            id="new-tag-color"
                            value="#28a745"
                        />
                    </div>
                    <div class="actions">
                        <button onclick="createTag()" class="btn btn-success">
                            Create Tag
                        </button>
                        <button
                            onclick="hideCreateTagForm()"
                            class="btn btn-secondary"
                        >
                            Cancel
                        </button>
                    </div>
                </div>

                <div id="tags-container">
                    <div class="loading">Click "Load Tags" to view tags</div>
                </div>

                <div id="tag-result" class="result" style="display: none"></div>
            </div>

            <!-- Notifications Tab -->
            <div id="NotificationsTab" class="tabcontent">
                <h2>üîî Notifications</h2>

                <div class="actions">
                    <button onclick="loadNotifications()" class="btn btn-info">
                        Load Notifications
                    </button>
                    <button
                        onclick="loadNotifications(true)"
                        class="btn btn-warning"
                    >
                        Unread Only
                    </button>
                    <button
                        onclick="markAllNotificationsAsRead()"
                        class="btn btn-success"
                    >
                        Mark All as Read
                    </button>
                    <button
                        onclick="deleteAllReadNotifications()"
                        class="btn btn-danger"
                    >
                        Delete All Read
                    </button>
                    <button
                        onclick="getNotificationStats()"
                        class="btn btn-secondary"
                    >
                        Statistics
                    </button>
                </div>

                <div id="notifications-container">
                    <div class="loading">
                        Click "Load Notifications" to view notifications
                    </div>
                </div>

                <div
                    id="notification-result"
                    class="result"
                    style="display: none"
                ></div>
            </div>

            <!-- User Tab -->
            <div id="UserTab" class="tabcontent">
                <h2>üë§ User Profile</h2>

                <div class="actions">
                    <button onclick="getUserProfile()" class="btn btn-info">
                        Load Profile
                    </button>
                    <button
                        onclick="getUserActivity()"
                        class="btn btn-secondary"
                    >
                        Recent Activity
                    </button>
                    <button onclick="searchUsers()" class="btn btn-warning">
                        Search Users
                    </button>
                </div>

                <div class="card">
                    <h4>Search Users</h4>
                    <div class="form-group">
                        <label for="user-search-query"
                            >Search Query (min 2 characters):</label
                        >
                        <input
                            type="text"
                            id="user-search-query"
                            placeholder="Enter username pattern..."
                        />
                    </div>
                    <button onclick="searchUsers()" class="btn">Search</button>
                </div>

                <div id="user-container">
                    <div class="loading">
                        Click "Load Profile" to view your profile
                    </div>
                </div>

                <div
                    id="user-result"
                    class="result"
                    style="display: none"
                ></div>
            </div>

            <!-- Export Tab -->
            <div id="ExportTab" class="tabcontent">
                <h2>üì§ Data Export</h2>

                <div class="actions">
                    <button onclick="getExportInfo()" class="btn btn-info">
                        Export Info
                    </button>
                    <button
                        onclick="exportUserDataBackup()"
                        class="btn btn-success"
                    >
                        Full Backup
                    </button>
                </div>

                <div class="grid">
                    <div class="card">
                        <h4>Export Tasks</h4>
                        <div class="actions">
                            <button onclick="exportTasks('csv')" class="btn">
                                Export CSV
                            </button>
                            <button onclick="exportTasks('json')" class="btn">
                                Export JSON
                            </button>
                            <button onclick="exportTasks('ical')" class="btn">
                                Export iCal
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <h4>Export Projects</h4>
                        <div class="actions">
                            <button onclick="exportProjects('csv')" class="btn">
                                Export CSV
                            </button>
                            <button
                                onclick="exportProjects('json')"
                                class="btn"
                            >
                                Export JSON
                            </button>
                        </div>
                    </div>
                </div>

                <div id="export-container">
                    <div class="loading">
                        Click "Export Info" to view available exports
                    </div>
                </div>

                <div
                    id="export-result"
                    class="result"
                    style="display: none"
                ></div>
            </div>

            <!-- Debug Panel -->
            <div style="padding: 20px">
                <div id="debug-panel">
                    <h3>üîß Debug Panel:</h3>
                    <pre id="debug-output">
Debug information will appear here...</pre
                    >
                    <button id="clear-debug" class="btn btn-danger">
                        Clear Debug
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Global variables
            let accessToken = localStorage.getItem("access_token");
            let currentPage = 1;
            let currentLimit = 20;

            // Debug logging function
            const debugLog = (message, data) => {
                const debugOutput = document.getElementById("debug-output");
                let formattedMessage =
                    new Date().toLocaleTimeString() + ": " + message;

                if (data) {
                    if (typeof data === "object") {
                        try {
                            formattedMessage +=
                                "\n" + JSON.stringify(data, null, 2);
                        } catch (e) {
                            formattedMessage +=
                                "\n[Object cannot be serialized]";
                        }
                    } else {
                        formattedMessage += "\n" + data;
                    }
                }

                debugOutput.textContent =
                    formattedMessage + "\n\n" + debugOutput.textContent;
                console.log(message, data);
            };

            // API call helper
            async function apiCall(endpoint, options = {}) {
                const url = endpoint.startsWith("http")
                    ? endpoint
                    : `/api${endpoint}`;
                const defaultOptions = {
                    headers: {
                        "Content-Type": "application/json",
                        ...(accessToken && {
                            Authorization: `Bearer ${accessToken}`,
                        }),
                    },
                };

                const mergedOptions = {
                    ...defaultOptions,
                    ...options,
                    headers: { ...defaultOptions.headers, ...options.headers },
                };

                debugLog(
                    `API Call: ${options.method || "GET"} ${url}`,
                    mergedOptions.body ? JSON.parse(mergedOptions.body) : null,
                );

                try {
                    const response = await fetch(url, mergedOptions);
                    const data = await response.json();

                    debugLog(`API Response: ${response.status}`, data);

                    if (!response.ok) {
                        throw new Error(
                            data.error || `HTTP ${response.status}`,
                        );
                    }

                    return data;
                } catch (error) {
                    debugLog(`API Error: ${error.message}`, error);
                    throw error;
                }
            }

            // Show result helper
            function showResult(containerId, message, isError = false) {
                const container = document.getElementById(containerId);
                container.style.display = "block";
                container.className = `result ${isError ? "error" : "success"}`;
                container.textContent = message;

                setTimeout(() => {
                    container.style.display = "none";
                }, 5000);
            }

            // Tab functionality
            function openTab(evt, tabName) {
                var i, tabcontent, tablinks;

                tabcontent = document.getElementsByClassName("tabcontent");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].classList.remove("active");
                }

                tablinks = document.getElementsByClassName("tablinks");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].classList.remove("active");
                }

                document.getElementById(tabName).classList.add("active");
                evt.currentTarget.classList.add("active");

                // Auto-load data when switching to certain tabs
                if (tabName === "UserTab" && accessToken) {
                    getUserProfile();
                }
            }

            // Authentication functions
            async function checkAuthStatus() {
                if (!accessToken) {
                    updateAuthStatus(false, "No token available");
                    return false;
                }

                try {
                    // Verify token with auth service through our middleware
                    const response = await apiCall("/user/profile");
                    updateAuthStatus(
                        true,
                        `Authenticated as user ID: ${response.data.user.authId}`,
                    );
                    return true;
                } catch (error) {
                    updateAuthStatus(
                        false,
                        `Authentication failed: ${error.message}`,
                    );
                    accessToken = null;
                    localStorage.removeItem("access_token");
                    return false;
                }
            }

            function updateAuthStatus(isAuthenticated, message) {
                const statusDiv = document.getElementById("auth-status");
                const infoDiv = document.getElementById("auth-info");
                const logoutBtn = document.getElementById("logout-btn");

                statusDiv.className = isAuthenticated
                    ? "authenticated"
                    : "unauthenticated";
                infoDiv.textContent = message;
                logoutBtn.style.display = isAuthenticated
                    ? "inline-block"
                    : "none";
            }

            function setManualToken() {
                const token = document
                    .getElementById("manual-token")
                    .value.trim();
                if (!token) {
                    showResult("auth-result", "Please enter a token", true);
                    return;
                }

                accessToken = token;
                localStorage.setItem("access_token", token);
                checkAuthStatus();
                showResult("auth-result", "Token set successfully");
            }

            function logout() {
                accessToken = null;
                localStorage.removeItem("access_token");
                updateAuthStatus(false, "Logged out");
                showResult("auth-result", "Logged out successfully");
            }

            // Tasks functions
            async function loadTasks(page = 1) {
                if (!accessToken) {
                    showResult(
                        "task-result",
                        "Please authenticate first",
                        true,
                    );
                    return;
                }

                try {
                    const search = document.getElementById("task-search").value;
                    const status =
                        document.getElementById("task-status-filter").value;
                    const priority = document.getElementById(
                        "task-priority-filter",
                    ).value;

                    const params = new URLSearchParams({
                        page: page,
                        limit: currentLimit,
                        ...(search && { search }),
                        ...(status && { status }),
                        ...(priority && { priority }),
                    });

                    const response = await apiCall(`/task?${params}`);
                    displayTasks(response.data);
                    showResult(
                        "task-result",
                        `Loaded ${response.data.tasks.length} tasks`,
                    );
                } catch (error) {
                    showResult(
                        "task-result",
                        `Failed to load tasks: ${error.message}`,
                        true,
                    );
                }
            }

            function displayTasks(data) {
                const container = document.getElementById("tasks-container");

                if (!data.tasks || data.tasks.length === 0) {
                    container.innerHTML =
                        '<div class="loading">No tasks found</div>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr>';
                html +=
                    "<th>Title</th><th>Status</th><th>Priority</th><th>Due Date</th><th>Owner</th><th>Actions</th>";
                html += "</tr></thead><tbody>";

                data.tasks.forEach((task) => {
                    html += "<tr>";
                    html += `<td><strong>${task.title}</strong>${task.description ? "<br><small>" + task.description.substring(0, 100) + "</small>" : ""}</td>`;
                    html += `<td><span class="status-badge status-${task.status.toLowerCase()}">${task.status}</span></td>`;
                    html += `<td><span class="priority-${task.priority.toLowerCase()}">${task.priority}</span></td>`;
                    html += `<td>${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : "-"}</td>`;
                    html += `<td>${task.owner.authId}</td>`;
                    html += `<td>
                    <button onclick="getTaskDetails(${task.id})" class="btn btn-info" style="padding: 4px 8px; font-size: 12px;">View</button>
                    <button onclick="deleteTask(${task.id})" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;">Delete</button>
                </td>`;
                    html += "</tr>";
                });

                html += "</tbody></table>";

                // Add pagination
                if (data.pagination) {
                    html += '<div class="pagination">';
                    if (data.pagination.page > 1) {
                        html += `<button onclick="loadTasks(${data.pagination.page - 1})" class="btn">Previous</button>`;
                    }
                    html += `<span class="current-page">Page ${data.pagination.page} of ${data.pagination.totalPages}</span>`;
                    if (data.pagination.page < data.pagination.totalPages) {
                        html += `<button onclick="loadTasks(${data.pagination.page + 1})" class="btn">Next</button>`;
                    }
                    html += "</div>";
                }

                container.innerHTML = html;
            }

            async function createTask() {
                if (!accessToken) {
                    showResult(
                        "task-result",
                        "Please authenticate first",
                        true,
                    );
                    return;
                }

                const title = document
                    .getElementById("new-task-title")
                    .value.trim();
                if (!title) {
                    showResult("task-result", "Title is required", true);
                    return;
                }

                const taskData = {
                    title,
                    description: document
                        .getElementById("new-task-description")
                        .value.trim(),
                    priority:
                        document.getElementById("new-task-priority").value,
                    dueDate:
                        document.getElementById("new-task-due-date").value ||
                        null,
                };

                try {
                    const response = await apiCall("/task", {
                        method: "POST",
                        body: JSON.stringify(taskData),
                    });

                    hideCreateTaskForm();
                    loadTasks();
                    showResult("task-result", "Task created successfully");

                    // Clear form
                    document.getElementById("new-task-title").value = "";
                    document.getElementById("new-task-description").value = "";
                    document.getElementById("new-task-due-date").value = "";
                } catch (error) {
                    showResult(
                        "task-result",
                        `Failed to create task: ${error.message}`,
                        true,
                    );
                }
            }

            async function deleteTask(taskId) {
                if (!confirm("Are you sure you want to delete this task?"))
                    return;

                try {
                    await apiCall(`/task/${taskId}`, { method: "DELETE" });
                    loadTasks();
                    showResult("task-result", "Task deleted successfully");
                } catch (error) {
                    showResult(
                        "task-result",
                        `Failed to delete task: ${error.message}`,
                        true,
                    );
                }
            }

            async function getTaskDetails(taskId) {
                try {
                    const response = await apiCall(`/task/${taskId}`);
                    const task = response.data;

                    const details = `
Task Details:
- ID: ${task.id}
- Title: ${task.title}
- Description: ${task.description || "No description"}
- Status: ${task.status}
- Priority: ${task.priority}
- Due Date: ${task.dueDate ? new Date(task.dueDate).toLocaleString() : "No due date"}
- Owner: ${task.owner.authId}
- Assignee: ${task.assignee ? task.assignee.authId : "Unassigned"}
- Project: ${task.project ? task.project.name : "No project"}
- Created: ${new Date(task.createdAt).toLocaleString()}
- Updated: ${new Date(task.updatedAt).toLocaleString()}
                `;

                    alert(details);
                } catch (error) {
                    showResult(
                        "task-result",
                        `Failed to get task details: ${error.message}`,
                        true,
                    );
                }
            }

            async function getTaskStatistics() {
                try {
                    const [statusStats, priorityStats, dueDateStats] =
                        await Promise.all([
                            apiCall("/task/statistics/status"),
                            apiCall("/task/statistics/priority"),
                            apiCall("/task/statistics/due-dates"),
                        ]);

                    const container =
                        document.getElementById("tasks-container");
                    container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number">${statusStats.data.total}</span>
                            <div class="stat-label">Total Tasks</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${statusStats.data.byStatus.TODO || 0}</span>
                            <div class="stat-label">To Do</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${statusStats.data.byStatus.IN_PROGRESS || 0}</span>
                            <div class="stat-label">In Progress</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${statusStats.data.byStatus.DONE || 0}</span>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${dueDateStats.data.overdue}</span>
                            <div class="stat-label">Overdue</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${statusStats.data.completion.completionRate}%</span>
                            <div class="stat-label">Completion Rate</div>
                        </div>
                    </div>
                    <button onclick="loadTasks()" class="btn btn-info">Back to Tasks</button>
                `;

                    showResult("task-result", "Statistics loaded successfully");
                } catch (error) {
                    showResult(
                        "task-result",
                        `Failed to load statistics: ${error.message}`,
                        true,
                    );
                }
            }

            async function getTasksDueSoon() {
                try {
                    const response = await apiCall("/task/due/soon?days=7");
                    const container =
                        document.getElementById("tasks-container");

                    const data = response.data;
                    let html = "<h3>Tasks Due Soon</h3>";

                    if (data.summary.total === 0) {
                        html += '<div class="loading">No tasks due soon</div>';
                    } else {
                        html += `<div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number" style="color: #dc3545;">${data.summary.overdue}</span>
                            <div class="stat-label">Overdue</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" style="color: #fd7e14;">${data.summary.today}</span>
                            <div class="stat-label">Due Today</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" style="color: #ffc107;">${data.summary.tomorrow}</span>
                            <div class="stat-label">Due Tomorrow</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" style="color: #17a2b8;">${data.summary.thisWeek}</span>
                            <div class="stat-label">This Week</div>
                        </div>
                    </div>`;

                        // Show categorized tasks
                        ["overdue", "today", "tomorrow", "thisWeek"].forEach(
                            (category) => {
                                const tasks = data.categorized[category];
                                if (tasks.length > 0) {
                                    html += `<h4>${category.charAt(0).toUpperCase() + category.slice(1)} (${tasks.length})</h4>`;
                                    html +=
                                        '<table class="data-table"><thead><tr><th>Title</th><th>Due Date</th><th>Priority</th></tr></thead><tbody>';
                                    tasks.forEach((task) => {
                                        html += `<tr>
                                    <td>${task.title}</td>
                                    <td>${new Date(task.dueDate).toLocaleString()}</td>
                                    <td><span class="priority-${task.priority.toLowerCase()}">${task.priority}</span></td>
                                </tr>`;
                                    });
                                    html += "</tbody></table>";
                                }
                            },
                        );
                    }

                    html +=
                        '<button onclick="loadTasks()" class="btn btn-info">Back to Tasks</button>';
                    container.innerHTML = html;

                    showResult(
                        "task-result",
                        `Found ${data.summary.total} tasks due soon`,
                    );
                } catch (error) {
                    showResult(
                        "task-result",
                        `Failed to load due soon tasks: ${error.message}`,
                        true,
                    );
                }
            }

            async function getOverdueTasks() {
                try {
                    const response = await apiCall("/task/due/overdue");
                    const container =
                        document.getElementById("tasks-container");

                    if (response.data.tasks.length === 0) {
                        container.innerHTML =
                            '<div class="loading">No overdue tasks</div><button onclick="loadTasks()" class="btn btn-info">Back to Tasks</button>';
                    } else {
                        let html = "<h3>Overdue Tasks</h3>";
                        html +=
                            '<table class="data-table"><thead><tr><th>Title</th><th>Due Date</th><th>Days Overdue</th><th>Priority</th></tr></thead><tbody>';

                        response.data.tasks.forEach((task) => {
                            html += `<tr>
                            <td>${task.title}</td>
                            <td>${new Date(task.dueDate).toLocaleString()}</td>
                            <td style="color: #dc3545; font-weight: bold;">${task.overdueDays} days</td>
                            <td><span class="priority-${task.priority.toLowerCase()}">${task.priority}</span></td>
                        </tr>`;
                        });

                        html += "</tbody></table>";
                        html +=
                            '<button onclick="loadTasks()" class="btn btn-info">Back to Tasks</button>';
                        container.innerHTML = html;
                    }

                    showResult(
                        "task-result",
                        `Found ${response.data.count} overdue tasks`,
                    );
                } catch (error) {
                    showResult(
                        "task-result",
                        `Failed to load overdue tasks: ${error.message}`,
                        true,
                    );
                }
            }

            // Form toggle functions
            function showCreateTaskForm() {
                document.getElementById("create-task-form").style.display =
                    "block";
            }

            function hideCreateTaskForm() {
                document.getElementById("create-task-form").style.display =
                    "none";
            }

            // Projects functions
            async function loadProjects() {
                if (!accessToken) {
                    showResult(
                        "project-result",
                        "Please authenticate first",
                        true,
                    );
                    return;
                }

                try {
                    const response = await apiCall("/project");
                    displayProjects(response.data);
                    showResult(
                        "project-result",
                        `Loaded ${response.data.projects.length} projects`,
                    );
                } catch (error) {
                    showResult(
                        "project-result",
                        `Failed to load projects: ${error.message}`,
                        true,
                    );
                }
            }

            function displayProjects(data) {
                const container = document.getElementById("projects-container");

                if (!data.projects || data.projects.length === 0) {
                    container.innerHTML =
                        '<div class="loading">No projects found</div>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr>';
                html +=
                    "<th>Name</th><th>Description</th><th>Owner</th><th>Members</th><th>Tasks</th><th>Actions</th>";
                html += "</tr></thead><tbody>";

                data.projects.forEach((project) => {
                    html += "<tr>";
                    html += `<td><strong>${project.name}</strong></td>`;
                    html += `<td>${project.description || "-"}</td>`;
                    html += `<td>${project.owner.authId}</td>`;
                    html += `<td>${project._count.members}</td>`;
                    html += `<td>${project._count.tasks}</td>`;
                    html += `<td>
                    <button onclick="getProjectDetails(${project.id})" class="btn btn-info" style="padding: 4px 8px; font-size: 12px;">View</button>
                    <button onclick="deleteProject(${project.id})" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;">Delete</button>
                </td>`;
                    html += "</tr>";
                });

                html += "</tbody></table>";
                container.innerHTML = html;
            }

            async function createProject() {
                if (!accessToken) {
                    showResult(
                        "project-result",
                        "Please authenticate first",
                        true,
                    );
                    return;
                }

                const name = document
                    .getElementById("new-project-name")
                    .value.trim();
                if (!name) {
                    showResult("project-result", "Name is required", true);
                    return;
                }

                const projectData = {
                    name,
                    description: document
                        .getElementById("new-project-description")
                        .value.trim(),
                };

                try {
                    await apiCall("/project", {
                        method: "POST",
                        body: JSON.stringify(projectData),
                    });

                    hideCreateProjectForm();
                    loadProjects();
                    showResult(
                        "project-result",
                        "Project created successfully",
                    );

                    // Clear form
                    document.getElementById("new-project-name").value = "";
                    document.getElementById("new-project-description").value =
                        "";
                } catch (error) {
                    showResult(
                        "project-result",
                        `Failed to create project: ${error.message}`,
                        true,
                    );
                }
            }

            async function deleteProject(projectId) {
                if (!confirm("Are you sure you want to delete this project?"))
                    return;

                try {
                    await apiCall(`/project/${projectId}`, {
                        method: "DELETE",
                    });
                    loadProjects();
                    showResult(
                        "project-result",
                        "Project deleted successfully",
                    );
                } catch (error) {
                    showResult(
                        "project-result",
                        `Failed to delete project: ${error.message}`,
                        true,
                    );
                }
            }

            async function getProjectDetails(projectId) {
                try {
                    const response = await apiCall(`/project/${projectId}`);
                    const project = response.data;

                    let details = `
Project Details:
- ID: ${project.id}
- Name: ${project.name}
- Description: ${project.description || "No description"}
- Owner: ${project.owner.authId}
- Members: ${project._count.members}
- Tasks: ${project._count.tasks}
- Created: ${new Date(project.createdAt).toLocaleString()}

Members:`;

                    project.members.forEach((member) => {
                        details += `\n- ${member.user.authId} (${member.role})`;
                    });

                    if (project.tasks.length > 0) {
                        details += "\n\nRecent Tasks:";
                        project.tasks.slice(0, 5).forEach((task) => {
                            details += `\n- ${task.title} (${task.status})`;
                        });
                    }

                    alert(details);
                } catch (error) {
                    showResult(
                        "project-result",
                        `Failed to get project details: ${error.message}`,
                        true,
                    );
                }
            }

            function showCreateProjectForm() {
                document.getElementById("create-project-form").style.display =
                    "block";
            }

            function hideCreateProjectForm() {
                document.getElementById("create-project-form").style.display =
                    "none";
            }

            // Categories functions
            async function loadCategories() {
                if (!accessToken) {
                    showResult(
                        "category-result",
                        "Please authenticate first",
                        true,
                    );
                    return;
                }

                try {
                    const response = await apiCall("/category");
                    displayCategories(response.data);
                    showResult(
                        "category-result",
                        `Loaded ${response.data.categories.length} categories`,
                    );
                } catch (error) {
                    showResult(
                        "category-result",
                        `Failed to load categories: ${error.message}`,
                        true,
                    );
                }
            }

            function displayCategories(data) {
                const container = document.getElementById(
                    "categories-container",
                );

                if (!data.categories || data.categories.length === 0) {
                    container.innerHTML =
                        '<div class="loading">No categories found</div>';
                    return;
                }

                let html = '<div class="grid">';

                data.categories.forEach((category) => {
                    html += `<div class="card">
                    <h4 style="color: ${category.color || "#333"};">üè∑Ô∏è ${category.name}</h4>
                    <p>Tasks: ${category._count ? category._count.tasks : 0}</p>
                    <p>Created: ${new Date(category.createdAt).toLocaleDateString()}</p>
                    <div class="actions">
                        <button onclick="deleteCategory(${category.id})" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;">Delete</button>
                    </div>
                </div>`;
                });

                html += "</div>";
                container.innerHTML = html;
            }

            async function createCategory() {
                if (!accessToken) {
                    showResult(
                        "category-result",
                        "Please authenticate first",
                        true,
                    );
                    return;
                }

                const name = document
                    .getElementById("new-category-name")
                    .value.trim();
                if (!name) {
                    showResult("category-result", "Name is required", true);
                    return;
                }

                const categoryData = {
                    name,
                    color: document.getElementById("new-category-color").value,
                };

                try {
                    await apiCall("/category", {
                        method: "POST",
                        body: JSON.stringify(categoryData),
                    });

                    hideCreateCategoryForm();
                    loadCategories();
                    showResult(
                        "category-result",
                        "Category created successfully",
                    );

                    // Clear form
                    document.getElementById("new-category-name").value = "";
                    document.getElementById("new-category-color").value =
                        "#4285F4";
                } catch (error) {
                    showResult(
                        "category-result",
                        `Failed to create category: ${error.message}`,
                        true,
                    );
                }
            }

            async function deleteCategory(categoryId) {
                if (!confirm("Are you sure you want to delete this category?"))
                    return;

                try {
                    await apiCall(`/category/${categoryId}`, {
                        method: "DELETE",
                    });
                    loadCategories();
                    showResult(
                        "category-result",
                        "Category deleted successfully",
                    );
                } catch (error) {
                    showResult(
                        "category-result",
                        `Failed to delete category: ${error.message}`,
                        true,
                    );
                }
            }

            async function getCategoryStats() {
                try {
                    const response = await apiCall("/category/stats");
                    const container = document.getElementById(
                        "categories-container",
                    );

                    let html = "<h3>Category Statistics</h3>";
                    html +=
                        '<table class="data-table"><thead><tr><th>Name</th><th>Total Tasks</th><th>Todo</th><th>In Progress</th><th>Done</th></tr></thead><tbody>';

                    response.data.forEach((category) => {
                        const stats = category.tasksByStatus;
                        html += `<tr>
                        <td style="color: ${category.color};">${category.name}</td>
                        <td>${category.totalTasks}</td>
                        <td>${stats.TODO || 0}</td>
                        <td>${stats.IN_PROGRESS || 0}</td>
                        <td>${stats.DONE || 0}</td>
                    </tr>`;
                    });

                    html += "</tbody></table>";
                    html +=
                        '<button onclick="loadCategories()" class="btn btn-info">Back to Categories</button>';
                    container.innerHTML = html;

                    showResult(
                        "category-result",
                        "Statistics loaded successfully",
                    );
                } catch (error) {
                    showResult(
                        "category-result",
                        `Failed to load statistics: ${error.message}`,
                        true,
                    );
                }
            }

            function showCreateCategoryForm() {
                document.getElementById("create-category-form").style.display =
                    "block";
            }

            function hideCreateCategoryForm() {
                document.getElementById("create-category-form").style.display =
                    "none";
            }

            // Tags functions
            async function loadTags() {
                if (!accessToken) {
                    showResult("tag-result", "Please authenticate first", true);
                    return;
                }

                try {
                    const response = await apiCall("/tag");
                    displayTags(response.data);
                    showResult(
                        "tag-result",
                        `Loaded ${response.data.tags.length} tags`,
                    );
                } catch (error) {
                    showResult(
                        "tag-result",
                        `Failed to load tags: ${error.message}`,
                        true,
                    );
                }
            }

            function displayTags(data) {
                const container = document.getElementById("tags-container");

                if (!data.tags || data.tags.length === 0) {
                    container.innerHTML =
                        '<div class="loading">No tags found</div>';
                    return;
                }

                let html = '<div class="grid">';

                data.tags.forEach((tag) => {
                    html += `<div class="card">
                    <h4 style="color: ${tag.color || "#333"};">üè∑Ô∏è ${tag.name}</h4>
                    <p>Tasks: ${tag._count ? tag._count.tasks : 0}</p>
                    <p>Created: ${new Date(tag.createdAt).toLocaleDateString()}</p>
                    <div class="actions">
                        <button onclick="deleteTag(${tag.id})" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;">Delete</button>
                    </div>
                </div>`;
                });

                html += "</div>";
                container.innerHTML = html;
            }

            async function createTag() {
                if (!accessToken) {
                    showResult("tag-result", "Please authenticate first", true);
                    return;
                }

                const name = document
                    .getElementById("new-tag-name")
                    .value.trim();
                if (!name) {
                    showResult("tag-result", "Name is required", true);
                    return;
                }

                const tagData = {
                    name,
                    color: document.getElementById("new-tag-color").value,
                };

                try {
                    await apiCall("/tag", {
                        method: "POST",
                        body: JSON.stringify(tagData),
                    });

                    hideCreateTagForm();
                    loadTags();
                    showResult("tag-result", "Tag created successfully");

                    // Clear form
                    document.getElementById("new-tag-name").value = "";
                    document.getElementById("new-tag-color").value = "#28a745";
                } catch (error) {
                    showResult(
                        "tag-result",
                        `Failed to create tag: ${error.message}`,
                        true,
                    );
                }
            }

            async function deleteTag(tagId) {
                if (!confirm("Are you sure you want to delete this tag?"))
                    return;

                try {
                    await apiCall(`/tag/${tagId}`, { method: "DELETE" });
                    loadTags();
                    showResult("tag-result", "Tag deleted successfully");
                } catch (error) {
                    showResult(
                        "tag-result",
                        `Failed to delete tag: ${error.message}`,
                        true,
                    );
                }
            }

            async function getTagStats() {
                try {
                    const response = await apiCall("/tag/stats");
                    const container = document.getElementById("tags-container");

                    let html = "<h3>Tag Statistics</h3>";
                    html +=
                        '<table class="data-table"><thead><tr><th>Name</th><th>Total Tasks</th><th>Todo</th><th>In Progress</th><th>Done</th></tr></thead><tbody>';

                    response.data.forEach((tag) => {
                        const stats = tag.tasksByStatus;
                        html += `<tr>
                        <td style="color: ${tag.color};">${tag.name}</td>
                        <td>${tag.totalTasks}</td>
                        <td>${stats.TODO || 0}</td>
                        <td>${stats.IN_PROGRESS || 0}</td>
                        <td>${stats.DONE || 0}</td>
                    </tr>`;
                    });

                    html += "</tbody></table>";
                    html +=
                        '<button onclick="loadTags()" class="btn btn-info">Back to Tags</button>';
                    container.innerHTML = html;

                    showResult("tag-result", "Statistics loaded successfully");
                } catch (error) {
                    showResult(
                        "tag-result",
                        `Failed to load statistics: ${error.message}`,
                        true,
                    );
                }
            }

            async function getPopularTags() {
                try {
                    const response = await apiCall("/tag/popular?limit=10");
                    const container = document.getElementById("tags-container");

                    if (response.data.length === 0) {
                        container.innerHTML =
                            '<div class="loading">No tags found</div><button onclick="loadTags()" class="btn btn-info">Back to Tags</button>';
                        return;
                    }

                    let html = "<h3>Most Popular Tags</h3>";
                    html +=
                        '<table class="data-table"><thead><tr><th>Rank</th><th>Tag</th><th>Task Count</th></tr></thead><tbody>';

                    response.data.forEach((tag, index) => {
                        html += `<tr>
                        <td>${index + 1}</td>
                        <td style="color: ${tag.color};">${tag.name}</td>
                        <td>${tag._count.tasks}</td>
                    </tr>`;
                    });

                    html += "</tbody></table>";
                    html +=
                        '<button onclick="loadTags()" class="btn btn-info">Back to Tags</button>';
                    container.innerHTML = html;

                    showResult(
                        "tag-result",
                        "Popular tags loaded successfully",
                    );
                } catch (error) {
                    showResult(
                        "tag-result",
                        `Failed to load popular tags: ${error.message}`,
                        true,
                    );
                }
            }

            function showCreateTagForm() {
                document.getElementById("create-tag-form").style.display =
                    "block";
            }

            function hideCreateTagForm() {
                document.getElementById("create-tag-form").style.display =
                    "none";
            }

            // Notifications functions
            async function loadNotifications(unreadOnly = false) {
                if (!accessToken) {
                    showResult(
                        "notification-result",
                        "Please authenticate first",
                        true,
                    );
                    return;
                }

                try {
                    const params = unreadOnly ? "?unreadOnly=true" : "";
                    const response = await apiCall(`/notification${params}`);
                    displayNotifications(response.data);
                    showResult(
                        "notification-result",
                        `Loaded ${response.data.notifications.length} notifications`,
                    );
                } catch (error) {
                    showResult(
                        "notification-result",
                        `Failed to load notifications: ${error.message}`,
                        true,
                    );
                }
            }

            function displayNotifications(data) {
                const container = document.getElementById(
                    "notifications-container",
                );

                if (!data.notifications || data.notifications.length === 0) {
                    container.innerHTML =
                        '<div class="loading">No notifications found</div>';
                    return;
                }

                let html = `<div class="stat-card" style="margin-bottom: 20px;">
                <span class="stat-number">${data.unreadCount}</span>
                <div class="stat-label">Unread Notifications</div>
            </div>`;

                html += '<table class="data-table"><thead><tr>';
                html +=
                    "<th>Type</th><th>Content</th><th>Status</th><th>Created</th><th>Actions</th>";
                html += "</tr></thead><tbody>";

                data.notifications.forEach((notification) => {
                    html += "<tr>";
                    html += `<td>${notification.type}</td>`;
                    html += `<td>${notification.content}</td>`;
                    html += `<td>${notification.isRead ? "‚úì Read" : "‚óè Unread"}</td>`;
                    html += `<td>${new Date(notification.createdAt).toLocaleString()}</td>`;
                    html += `<td>`;
                    if (!notification.isRead) {
                        html += `<button onclick="markNotificationAsRead(${notification.id})" class="btn btn-success" style="padding: 4px 8px; font-size: 12px;">Mark Read</button>`;
                    }
                    html += `<button onclick="deleteNotification(${notification.id})" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;">Delete</button>`;
                    html += `</td>`;
                    html += "</tr>";
                });

                html += "</tbody></table>";
                container.innerHTML = html;
            }

            async function markNotificationAsRead(notificationId) {
                try {
                    await apiCall(`/notification/${notificationId}/read`, {
                        method: "PUT",
                    });
                    loadNotifications();
                    showResult(
                        "notification-result",
                        "Notification marked as read",
                    );
                } catch (error) {
                    showResult(
                        "notification-result",
                        `Failed to mark notification as read: ${error.message}`,
                        true,
                    );
                }
            }

            async function markAllNotificationsAsRead() {
                try {
                    await apiCall("/notification/read/all", { method: "PUT" });
                    loadNotifications();
                    showResult(
                        "notification-result",
                        "All notifications marked as read",
                    );
                } catch (error) {
                    showResult(
                        "notification-result",
                        `Failed to mark all notifications as read: ${error.message}`,
                        true,
                    );
                }
            }

            async function deleteNotification(notificationId) {
                try {
                    await apiCall(`/notification/${notificationId}`, {
                        method: "DELETE",
                    });
                    loadNotifications();
                    showResult("notification-result", "Notification deleted");
                } catch (error) {
                    showResult(
                        "notification-result",
                        `Failed to delete notification: ${error.message}`,
                        true,
                    );
                }
            }

            async function deleteAllReadNotifications() {
                if (
                    !confirm(
                        "Are you sure you want to delete all read notifications?",
                    )
                )
                    return;

                try {
                    await apiCall("/notification/read/all", {
                        method: "DELETE",
                    });
                    loadNotifications();
                    showResult(
                        "notification-result",
                        "All read notifications deleted",
                    );
                } catch (error) {
                    showResult(
                        "notification-result",
                        `Failed to delete read notifications: ${error.message}`,
                        true,
                    );
                }
            }

            async function getNotificationStats() {
                try {
                    const response = await apiCall("/notification/stats");
                    const container = document.getElementById(
                        "notifications-container",
                    );

                    const stats = response.data;
                    let html = "<h3>Notification Statistics</h3>";
                    html += `<div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number">${stats.totalCount}</span>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${stats.unreadCount}</span>
                        <div class="stat-label">Unread</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${stats.readCount}</span>
                        <div class="stat-label">Read</div>
                    </div>
                </div>`;

                    if (Object.keys(stats.byType).length > 0) {
                        html += "<h4>By Type</h4>";
                        html +=
                            '<table class="data-table"><thead><tr><th>Type</th><th>Count</th></tr></thead><tbody>';
                        Object.entries(stats.byType).forEach(
                            ([type, count]) => {
                                html += `<tr><td>${type}</td><td>${count}</td></tr>`;
                            },
                        );
                        html += "</tbody></table>";
                    }

                    html +=
                        '<button onclick="loadNotifications()" class="btn btn-info">Back to Notifications</button>';
                    container.innerHTML = html;

                    showResult(
                        "notification-result",
                        "Statistics loaded successfully",
                    );
                } catch (error) {
                    showResult(
                        "notification-result",
                        `Failed to load statistics: ${error.message}`,
                        true,
                    );
                }
            }

            // User functions
            async function getUserProfile() {
                if (!accessToken) {
                    showResult(
                        "user-result",
                        "Please authenticate first",
                        true,
                    );
                    return;
                }

                try {
                    const response = await apiCall("/user/profile");
                    displayUserProfile(response.data);
                    showResult("user-result", "Profile loaded successfully");
                } catch (error) {
                    showResult(
                        "user-result",
                        `Failed to load profile: ${error.message}`,
                        true,
                    );
                }
            }

            function displayUserProfile(data) {
                const container = document.getElementById("user-container");

                let html = "<h3>User Profile</h3>";
                html += `<div class="card">
                <h4>User Information</h4>
                <p><strong>Auth ID:</strong> ${data.user.authId}</p>
                <p><strong>Internal ID:</strong> ${data.user.id}</p>
                <p><strong>Member Since:</strong> ${new Date(data.user.createdAt).toLocaleDateString()}</p>
                <p><strong>Last Updated:</strong> ${new Date(data.user.updatedAt).toLocaleDateString()}</p>
            </div>`;

                html += "<h4>Statistics</h4>";
                html += `<div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number">${data.statistics.ownedTasks}</span>
                    <div class="stat-label">Owned Tasks</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${data.statistics.assignedTasks}</span>
                    <div class="stat-label">Assigned Tasks</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${data.statistics.projects}</span>
                    <div class="stat-label">Projects</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${data.statistics.categories}</span>
                    <div class="stat-label">Categories</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${data.statistics.tags}</span>
                    <div class="stat-label">Tags</div>
                </div>
            </div>`;

                if (Object.keys(data.statistics.tasksByStatus).length > 0) {
                    html += "<h4>Tasks by Status</h4>";
                    html +=
                        '<table class="data-table"><thead><tr><th>Status</th><th>Count</th></tr></thead><tbody>';
                    Object.entries(data.statistics.tasksByStatus).forEach(
                        ([status, count]) => {
                            html += `<tr><td>${status}</td><td>${count}</td></tr>`;
                        },
                    );
                    html += "</tbody></table>";
                }

                container.innerHTML = html;
            }

            async function getUserActivity() {
                try {
                    const response = await apiCall("/user/activity");
                    const container = document.getElementById("user-container");

                    let html = "<h3>Recent Activity</h3>";

                    if (response.data.recentTasks.length > 0) {
                        html += "<h4>Recent Tasks</h4>";
                        html +=
                            '<table class="data-table"><thead><tr><th>Title</th><th>Status</th><th>Updated</th></tr></thead><tbody>';
                        response.data.recentTasks.forEach((task) => {
                            html += `<tr>
                            <td>${task.title}</td>
                            <td><span class="status-badge status-${task.status.toLowerCase()}">${task.status}</span></td>
                            <td>${new Date(task.updatedAt).toLocaleString()}</td>
                        </tr>`;
                        });
                        html += "</tbody></table>";
                    }

                    if (response.data.recentProjects.length > 0) {
                        html += "<h4>Recent Projects</h4>";
                        html +=
                            '<table class="data-table"><thead><tr><th>Name</th><th>Tasks</th><th>Members</th><th>Updated</th></tr></thead><tbody>';
                        response.data.recentProjects.forEach((project) => {
                            html += `<tr>
                            <td>${project.name}</td>
                            <td>${project._count.tasks}</td>
                            <td>${project._count.members}</td>
                            <td>${new Date(project.updatedAt).toLocaleString()}</td>
                        </tr>`;
                        });
                        html += "</tbody></table>";
                    }

                    if (
                        response.data.recentTasks.length === 0 &&
                        response.data.recentProjects.length === 0
                    ) {
                        html += '<div class="loading">No recent activity</div>';
                    }

                    html +=
                        '<button onclick="getUserProfile()" class="btn btn-info">Back to Profile</button>';
                    container.innerHTML = html;

                    showResult("user-result", "Activity loaded successfully");
                } catch (error) {
                    showResult(
                        "user-result",
                        `Failed to load activity: ${error.message}`,
                        true,
                    );
                }
            }

            async function searchUsers() {
                const query = document
                    .getElementById("user-search-query")
                    .value.trim();
                if (query.length < 2) {
                    showResult(
                        "user-result",
                        "Search query must be at least 2 characters long",
                        true,
                    );
                    return;
                }

                try {
                    const response = await apiCall(
                        `/user/search?query=${encodeURIComponent(query)}`,
                    );
                    const container = document.getElementById("user-container");

                    let html = "<h3>Search Results</h3>";

                    if (response.data.length === 0) {
                        html += '<div class="loading">No users found</div>';
                    } else {
                        html +=
                            '<table class="data-table"><thead><tr><th>Auth ID</th><th>Internal ID</th><th>Member Since</th></tr></thead><tbody>';
                        response.data.forEach((user) => {
                            html += `<tr>
                            <td>${user.authId}</td>
                            <td>${user.id}</td>
                            <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                        </tr>`;
                        });
                        html += "</tbody></table>";
                    }

                    html +=
                        '<button onclick="getUserProfile()" class="btn btn-info">Back to Profile</button>';
                    container.innerHTML = html;

                    showResult(
                        "user-result",
                        `Found ${response.data.length} users`,
                    );
                } catch (error) {
                    showResult(
                        "user-result",
                        `Failed to search users: ${error.message}`,
                        true,
                    );
                }
            }

            // Export functions
            async function getExportInfo() {
                if (!accessToken) {
                    showResult(
                        "export-result",
                        "Please authenticate first",
                        true,
                    );
                    return;
                }

                try {
                    const response = await apiCall("/export/info");
                    displayExportInfo(response.data);
                    showResult("export-result", "Export information loaded");
                } catch (error) {
                    showResult(
                        "export-result",
                        `Failed to load export info: ${error.message}`,
                        true,
                    );
                }
            }

            function displayExportInfo(data) {
                const container = document.getElementById("export-container");

                let html = "<h3>Available Data for Export</h3>";
                html += `<div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number">${data.availableData.tasks}</span>
                    <div class="stat-label">Tasks</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${data.availableData.projects}</span>
                    <div class="stat-label">Projects</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${data.availableData.categories}</span>
                    <div class="stat-label">Categories</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${data.availableData.tags}</span>
                    <div class="stat-label">Tags</div>
                </div>
            </div>`;

                html += "<h4>Supported Export Formats</h4>";
                html +=
                    '<table class="data-table"><thead><tr><th>Data Type</th><th>Formats</th></tr></thead><tbody>';
                Object.entries(data.supportedFormats).forEach(
                    ([type, formats]) => {
                        html += `<tr><td>${type.charAt(0).toUpperCase() + type.slice(1)}</td><td>${formats.join(", ")}</td></tr>`;
                    },
                );
                html += "</tbody></table>";

                container.innerHTML = html;
            }

            async function exportTasks(format) {
                if (!accessToken) {
                    showResult(
                        "export-result",
                        "Please authenticate first",
                        true,
                    );
                    return;
                }

                try {
                    const url = `/api/export/tasks/${format}`;
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = `tasks_export.${format}`;

                    // Add authorization header for download
                    const response = await fetch(url, {
                        headers: { Authorization: `Bearer ${accessToken}` },
                    });

                    if (!response.ok) {
                        throw new Error("Export failed");
                    }

                    const blob = await response.blob();
                    const downloadUrl = URL.createObjectURL(blob);
                    link.href = downloadUrl;
                    link.click();
                    URL.revokeObjectURL(downloadUrl);

                    showResult(
                        "export-result",
                        `Tasks exported as ${format.toUpperCase()}`,
                    );
                } catch (error) {
                    showResult(
                        "export-result",
                        `Failed to export tasks: ${error.message}`,
                        true,
                    );
                }
            }

            async function exportProjects(format) {
                if (!accessToken) {
                    showResult(
                        "export-result",
                        "Please authenticate first",
                        true,
                    );
                    return;
                }

                try {
                    const url = `/api/export/projects/${format}`;
                    const response = await fetch(url, {
                        headers: { Authorization: `Bearer ${accessToken}` },
                    });

                    if (!response.ok) {
                        throw new Error("Export failed");
                    }

                    const blob = await response.blob();
                    const downloadUrl = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = downloadUrl;
                    link.download = `projects_export.${format}`;
                    link.click();
                    URL.revokeObjectURL(downloadUrl);

                    showResult(
                        "export-result",
                        `Projects exported as ${format.toUpperCase()}`,
                    );
                } catch (error) {
                    showResult(
                        "export-result",
                        `Failed to export projects: ${error.message}`,
                        true,
                    );
                }
            }

            async function exportUserDataBackup() {
                if (!accessToken) {
                    showResult(
                        "export-result",
                        "Please authenticate first",
                        true,
                    );
                    return;
                }

                try {
                    const url = "/api/export/backup";
                    const response = await fetch(url, {
                        headers: { Authorization: `Bearer ${accessToken}` },
                    });

                    if (!response.ok) {
                        throw new Error("Backup export failed");
                    }

                    const blob = await response.blob();
                    const downloadUrl = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = downloadUrl;
                    link.download = `user_data_backup_${new Date().toISOString().split("T")[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(downloadUrl);

                    showResult(
                        "export-result",
                        "Full user data backup exported",
                    );
                } catch (error) {
                    showResult(
                        "export-result",
                        `Failed to export backup: ${error.message}`,
                        true,
                    );
                }
            }

            // Event listeners
            document.addEventListener("DOMContentLoaded", function () {
                debugLog("DB Service Test Interface loaded");

                // Check if we have a token and verify it
                if (accessToken) {
                    checkAuthStatus();
                }

                // Set up event listeners
                document
                    .getElementById("check-auth-btn")
                    .addEventListener("click", checkAuthStatus);
                document
                    .getElementById("logout-btn")
                    .addEventListener("click", logout);
                document
                    .getElementById("clear-debug")
                    .addEventListener("click", function () {
                        document.getElementById("debug-output").textContent =
                            "Debug panel cleared.";
                    });

                // Open default tab
                document.getElementById("defaultOpen").click();
            });

            // Check for tokens from URL hash (OAuth redirect)
            if (window.location.hash) {
                const urlParams = new URLSearchParams(
                    window.location.hash.substring(1),
                );
                const tokenFromUrl = urlParams.get("access_token");

                if (tokenFromUrl) {
                    accessToken = tokenFromUrl;
                    localStorage.setItem("access_token", tokenFromUrl);
                    history.replaceState(null, null, " ");
                    checkAuthStatus();
                }
            }
        </script>
    </body>
</html>
